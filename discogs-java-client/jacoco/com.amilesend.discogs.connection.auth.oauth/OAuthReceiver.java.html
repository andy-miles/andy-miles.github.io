<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OAuthReceiver.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">discogs-java-client</a> &gt; <a href="index.source.html" class="el_package">com.amilesend.discogs.connection.auth.oauth</a> &gt; <span class="el_source">OAuthReceiver.java</span></div><h1>OAuthReceiver.java</h1><pre class="source lang-java linenums">/*
 * discogs-java-client - A Java client to access the Discogs API
 * Copyright Â© 2025 Andy Miles (andy.miles@amilesend.com)
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package com.amilesend.discogs.connection.auth.oauth;

import com.amilesend.client.util.StringUtils;
import com.amilesend.client.util.Validate;
import com.amilesend.client.util.VisibleForTesting;
import com.sun.net.httpserver.HttpServer;
import lombok.AccessLevel;
import lombok.Builder;
import lombok.Getter;
import lombok.extern.slf4j.Slf4j;

import java.net.InetSocketAddress;

/**
 * A customized OAuth receiver that handles the OAuth token exchange redirect by hosting a HTTP server
 * to capture the auth and/or error code specific to Box.net OAuth flow.
 *
 * This is based on &lt;a href=&quot;https://t.ly/4YOIa&quot;&gt;LocalServerReceiver&lt;/a&gt; defined in the
 * &lt;a href=&quot;https://t.ly/Ymraz&quot;&gt;google-oauth-java-client&lt;/a&gt; library.
 */
<span class="fc" id="L38">@Slf4j</span>
public class OAuthReceiver implements AutoCloseable {
    private static final int DEFAULT_SYSTEM_BACKLOG = 0;

    /** Max allowed port range for listening for the OAuth redirect. */
    @VisibleForTesting
    static final int MAX_PORT_RANGE = 65535;

    @VisibleForTesting
    @Getter(value = AccessLevel.PACKAGE)
    private final OAuthReceiverCallback callback;
    /** The host of the receiver. */
    @Getter
    private final String host;
    /** The path to listen for the redirect. */
    @Getter
    private final String callbackPath;
    /** The port of the receiver to listen on. */
    @Getter
    private final int port;
    private HttpServer server;

    /**
     * Builds a new {@code OAuthReceiver}.
     *
     * @param host host of the receiver (Default: {@literal localhost})
     * @param port optional port of the receiver to listen on
     * @param callbackPath the path to listen for the redirect (Default: {@literal /Callback})
     * @param successLandingPageUrl optional URL for a custom successful landing page
     * @param failureLandingPageUrl optional URL for a custom failure landing page
     */
    @Builder
    protected OAuthReceiver(
            final String host,
            final int port,
            final String callbackPath,
            final String successLandingPageUrl,
<span class="fc" id="L75">            final String failureLandingPageUrl) {</span>
<span class="pc bpc" id="L76" title="1 of 2 branches missed.">        this.host = StringUtils.isNotBlank(host) ? host : &quot;localhost&quot;;</span>
<span class="fc bfc" id="L77" title="All 2 branches covered.">        this.callbackPath = StringUtils.isNotBlank(callbackPath) ? callbackPath : &quot;/Callback&quot;;</span>
<span class="fc" id="L78">        validatePort(port);</span>
<span class="fc" id="L79">        this.port = port;</span>
<span class="fc" id="L80">        callback = OAuthReceiverCallback.builder()</span>
<span class="fc" id="L81">                .callbackPath(this.callbackPath)</span>
<span class="fc" id="L82">                .successLandingPageUrl(successLandingPageUrl)</span>
<span class="fc" id="L83">                .failureLandingPageUrl(failureLandingPageUrl)</span>
<span class="fc" id="L84">                .build();</span>
<span class="fc" id="L85">    }</span>

    /**
     * Starts the HTTP server to handle OAuth callbacks.
     *
     * @throws OAuthReceiverException if an error occurred while starting the HTTP server
     */
    public void start() {
<span class="fc bfc" id="L93" title="All 2 branches covered.">        if (server != null) {</span>
<span class="fc" id="L94">            return;</span>
        }

        try {
<span class="fc" id="L98">            server = HttpServer.create(new InetSocketAddress(port), DEFAULT_SYSTEM_BACKLOG);</span>
<span class="fc" id="L99">            server.createContext(callbackPath, callback);</span>
<span class="fc" id="L100">            server.setExecutor(null);</span>
<span class="fc" id="L101">            server.start();</span>
<span class="fc" id="L102">        } catch (final Exception ex) {</span>
<span class="fc" id="L103">            throw new OAuthReceiverException(&quot;Error starting OAuthReceiver&quot;, ex);</span>
<span class="fc" id="L104">        }</span>
<span class="fc" id="L105">    }</span>

    /**
     * Stops the running HTTP server.
     *
     * @throws OAuthReceiverException if an error occurred while stopping the server
     */
    public void stop() {
<span class="fc" id="L113">        callback.releaseLock();</span>
<span class="fc bfc" id="L114" title="All 2 branches covered.">        if (server != null) {</span>
            try {
<span class="fc" id="L116">                server.stop(0);</span>
<span class="fc" id="L117">            } catch (final Exception ex) {</span>
<span class="fc" id="L118">                throw new OAuthReceiverException(&quot;Error stopping OAuthReceiver&quot;, ex);</span>
<span class="fc" id="L119">            }</span>
<span class="fc" id="L120">            server = null;</span>
        }
<span class="fc" id="L122">    }</span>

    /**
     * Closes the HTTP server resource.
     *
     * @throws OAuthReceiverException if an error occurred while closing the HTTP server resource
     */
    @Override
    public void close() {
<span class="fc" id="L131">        stop();</span>
<span class="fc" id="L132">    }</span>

    /**
     * Gets the redirect URI based on the running HTTP server resource.
     *
     * @return the redirect URI
     */
    public String getRedirectUri() {
<span class="fc" id="L140">        return new StringBuilder(&quot;http://&quot;)</span>
<span class="fc" id="L141">                .append(getHost())</span>
<span class="fc" id="L142">                .append(&quot;:&quot;)</span>
<span class="fc" id="L143">                .append(port)</span>
<span class="fc" id="L144">                .append(callbackPath)</span>
<span class="fc" id="L145">                .toString();</span>
    }

    /**
     * Blocks until the server receives a login result, or the server is stopped by {@link #stop()},
     * to return an authorization code.
     *
     * @return authorization code if login succeeds; may return {@code null} if the server is stopped
     *     by {@link #close()}
     * @throws OAuthReceiverException if the server receives an error code (through an HTTP request parameter
     *     {@code error})
     */
    public String waitForCode() {
<span class="fc" id="L158">        return callback.waitForCode();</span>
    }

    private static void validatePort(final int port) {
<span class="pc bpc" id="L162" title="1 of 4 branches missed.">        Validate.isTrue(port &gt; 0 &amp;&amp; port &lt;= MAX_PORT_RANGE,</span>
                &quot;Invalid port.  Must be between 0 and &quot; + MAX_PORT_RANGE);
<span class="fc" id="L164">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>